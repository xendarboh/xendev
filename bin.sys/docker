#!/bin/bash
# This script intercepts Docker commands to strip the --user flag
# for compatibility with Sysbox environments.

declare -a args
skip_next=false
fix_user=false

for arg in "$@"; do
  if [ "$skip_next" = true ]; then
    skip_next=false
    continue
  fi

  case "$arg" in
  --user=* | -u=*)
    # Matches --user=1000 or -u=1000
    fix_user=true
    continue
    ;;
  --user | -u)
    # Matches --user 1000 or -u 1000 (skips the next value)
    fix_user=true
    skip_next=true
    continue
    ;;
  *)
    args+=("$arg")
    ;;
  esac
done

# Execute the original docker binary with the filtered arguments
start_time=$(date +%s)
/usr/bin/docker "${args[@]}"
exit_code=$?

# Fix any root-owned files created during this docker run
if [[ $(whoami) != "root" && "$fix_user" = true && "$PWD" != "$HOME" ]]; then
  echo "[xendev] fixing file permissions..."
  find . -maxdepth 5 -newermt "@${start_time}" -user root -exec sudo chown -c $(id -u):$(id -g) {} + 2>/dev/null
  find ~/ -maxdepth 2 -newermt "@${start_time}" -user root -exec sudo chown -R $(id -u):$(id -g) {} + 2>/dev/null
fi

exit $exit_code
